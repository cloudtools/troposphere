name: Automated Maintenance
on:
  schedule:
    - cron: '0 13 * * *'
  workflow_dispatch: # Enables on-demand/manual triggering
jobs:
  job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - run: |
          python -m pip install -r requirements-dev.txt
          make spec
          make regen
          make test
          make lint
      - name: Set spec version variable
        id: vars
        run: |
          echo "pr_title=Updates from spec version $(jq -r .ResourceSpecificationVersion CloudFormationResourceSpecification.json)" >> $GITHUB_OUTPUT
      - uses: peter-evans/create-pull-request@v4
        with:
          commit-message: |
            ${{ steps.vars.outputs.pr_title }}
          title: ${{ steps.vars.outputs.pr_title }}
          delete-branch: true
          body: |
            Autogenerated by maintenance action

            If tests are stuck on https://github.com/peter-evans/create-pull-request/issues/48:
            ["Manually close pull requests and immediately reopen them. This will enable `on: pull_request` workflows to run and be added as checks."](https://github.com/peter-evans/create-pull-request/blob/master/docs/concepts-guidelines.md#triggering-further-workflow-runs)
