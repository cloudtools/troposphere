{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "ALB-ECS App Template",
    "Parameters": {
        "ContainerPort": {
            "Description": "This is the port specified in the Dockerfile",
            "Type": "String"
        },
        "DatabaseEndpoint": {
            "Description": "Customer database endpoint",
            "Type": "String"
        },
        "DockerImage": {
            "Description": "Docker image to deploy",
            "Type": "String"
        },
        "Environment": {
            "Description": "Deployment Environment",
            "Type": "String"
        },
        "HealthCheckPath": {
            "Description": "Health Check Path. Don't include the base path of your service name. For example, just write: '/ping",
            "Type": "String"
        },
        "NumberOfContainers": {
            "Default": "1",
            "Description": "Optionally specify the number of containers of your service you want to run",
            "Type": "String"
        },
        "Priority": {
            "Description": "ALB Listener Rule Priority. Can't conflict with another rule",
            "Type": "String"
        },
        "ServiceName": {
            "Description": "Service Name",
            "Type": "String"
        }
    },
    "Resources": {
        "APITargetGroup": {
            "Properties": {
                "HealthCheckIntervalSeconds": "10",
                "HealthCheckPath": {
                    "Fn::Join": [
                        "",
                        [
                            "/api/",
                            {
                                "Ref": "ServiceName"
                            },
                            {
                                "Ref": "HealthCheckPath"
                            }
                        ]
                    ]
                },
                "HealthCheckProtocol": "HTTP",
                "HealthCheckTimeoutSeconds": "9",
                "HealthyThresholdCount": "2",
                "Matcher": {
                    "HttpCode": "200"
                },
                "Name": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "ServiceName"
                            },
                            "-TargetGroup"
                        ]
                    ]
                },
                "Port": {
                    "Ref": "ContainerPort"
                },
                "Protocol": "HTTP",
                "UnhealthyThresholdCount": "2",
                "VpcId": {
                    "Fn::ImportValue": {
                        "Fn::Join": [
                            "",
                            [
                                "ECSClusterVPC-",
                                {
                                    "Ref": "Environment"
                                }
                            ]
                        ]
                    }
                }
            },
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup"
        },
        "AppLogGroup": {
            "Properties": {
                "RetentionInDays": 7
            },
            "Type": "AWS::Logs::LogGroup"
        },
        "BasicAppPermissions": {
            "Properties": {
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "logs:Create*",
                                "logs:PutLogEvents"
                            ],
                            "Effect": "Allow",
                            "Resource": [
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:aws:logs:",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            ":",
                                            {
                                                "Ref": "AWS::AccountId"
                                            },
                                            ":log-group:",
                                            {
                                                "Ref": "AppLogGroup"
                                            },
                                            ":*"
                                        ]
                                    ]
                                },
                                "*"
                            ]
                        },
                        {
                            "Action": [
                                "cloudwatch:PutMetricData"
                            ],
                            "Effect": "Allow",
                            "Resource": [
                                "*"
                            ]
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "PolicyName": "BasicAppPermissions",
                "Roles": [
                    {
                        "Ref": "ECSTaskRole"
                    }
                ]
            },
            "Type": "AWS::IAM::Policy"
        },
        "CWLogsRole": {
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "sts:AssumeRole"
                            ],
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "Path": "/"
            },
            "Type": "AWS::IAM::Role"
        },
        "ECSService": {
            "Properties": {
                "Cluster": {
                    "Fn::ImportValue": {
                        "Fn::Join": [
                            "",
                            [
                                "ECSClusterID-",
                                {
                                    "Ref": "Environment"
                                }
                            ]
                        ]
                    }
                },
                "DesiredCount": {
                    "Ref": "NumberOfContainers"
                },
                "LoadBalancers": [
                    {
                        "ContainerName": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "ServiceName"
                                    },
                                    "-api"
                                ]
                            ]
                        },
                        "ContainerPort": {
                            "Ref": "ContainerPort"
                        },
                        "TargetGroupArn": {
                            "Ref": "APITargetGroup"
                        }
                    }
                ],
                "Role": {
                    "Ref": "ECSServiceRole"
                },
                "TaskDefinition": {
                    "Ref": "ServiceTask"
                }
            },
            "Type": "AWS::ECS::Service"
        },
        "ECSServiceRole": {
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "sts:AssumeRole"
                            ],
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ecs.amazonaws.com"
                                ]
                            }
                        }
                    ],
                    "Version": "2008-10-17"
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceRole"
                ],
                "Path": "/"
            },
            "Type": "AWS::IAM::Role"
        },
        "ECSTaskRole": {
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "sts:AssumeRole"
                            ],
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ecs-tasks.amazonaws.com"
                                ]
                            }
                        }
                    ],
                    "Version": "2008-10-17"
                },
                "Path": "/"
            },
            "Type": "AWS::IAM::Role"
        },
        "ESPostingPermissions": {
            "Properties": {
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "es:ESHttpPost",
                                "es:ESHttpPut"
                            ],
                            "Effect": "Allow",
                            "Resource": [
                                {
                                    "Fn::ImportValue": {
                                        "Fn::Join": [
                                            "",
                                            [
                                                "GlobalESClusterARN-",
                                                {
                                                    "Ref": "Environment"
                                                }
                                            ]
                                        ]
                                    }
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Fn::ImportValue": {
                                                    "Fn::Join": [
                                                        "",
                                                        [
                                                            "GlobalESClusterARN-",
                                                            {
                                                                "Ref": "Environment"
                                                            }
                                                        ]
                                                    ]
                                                }
                                            },
                                            "/*"
                                        ]
                                    ]
                                }
                            ]
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "PolicyName": "ESPostingPermissions",
                "Roles": [
                    {
                        "Ref": "CWLogsRole"
                    }
                ]
            },
            "Type": "AWS::IAM::Policy"
        },
        "ListenerRuleApi": {
            "Properties": {
                "Actions": [
                    {
                        "TargetGroupArn": {
                            "Ref": "APITargetGroup"
                        },
                        "Type": "forward"
                    }
                ],
                "Conditions": [
                    {
                        "Field": "path-pattern",
                        "Values": [
                            {
                                "Fn::Join": [
                                    "",
                                    [
                                        "/api/",
                                        {
                                            "Ref": "ServiceName"
                                        },
                                        "/*"
                                    ]
                                ]
                            }
                        ]
                    }
                ],
                "ListenerArn": {
                    "Fn::ImportValue": {
                        "Fn::Join": [
                            "",
                            [
                                "ALBHttpListener-",
                                {
                                    "Ref": "Environment"
                                }
                            ]
                        ]
                    }
                },
                "Priority": {
                    "Ref": "Priority"
                }
            },
            "Type": "AWS::ElasticLoadBalancingV2::ListenerRule"
        },
        "ServiceTask": {
            "Properties": {
                "ContainerDefinitions": [
                    {
                        "Cpu": 512,
                        "Environment": [
                            {
                                "Name": "DB_ENDPOINT",
                                "Value": {
                                    "Ref": "DatabaseEndpoint"
                                }
                            },
                            {
                                "Name": "CW_LOGS_GROUP",
                                "Value": {
                                    "Ref": "AppLogGroup"
                                }
                            },
                            {
                                "Name": "REGION",
                                "Value": {
                                    "Ref": "AWS::Region"
                                }
                            }
                        ],
                        "Essential": "true",
                        "Image": {
                            "Ref": "DockerImage"
                        },
                        "LogConfiguration": {
                            "LogDriver": "awslogs",
                            "Options": {
                                "awslogs-group": {
                                    "Ref": "AppLogGroup"
                                },
                                "awslogs-region": {
                                    "Ref": "AWS::Region"
                                }
                            }
                        },
                        "Memory": 512,
                        "Name": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "ServiceName"
                                    },
                                    "-api"
                                ]
                            ]
                        },
                        "PortMappings": [
                            {
                                "ContainerPort": {
                                    "Ref": "ContainerPort"
                                }
                            }
                        ]
                    }
                ],
                "TaskRoleArn": {
                    "Fn::GetAtt": [
                        "ECSTaskRole",
                        "Arn"
                    ]
                },
                "Volumes": [
                    {
                        "Name": "default"
                    }
                ]
            },
            "Type": "AWS::ECS::TaskDefinition"
        }
    }
}
